# Matrix Setup Script

Автоматизированный скрипт для установки Matrix Synapse + Element Web + Synapse Admin + PostgreSQL + Coturn на Ubuntu 20/22 LTS.

## Особенности

- Автоматическое определение типа сервера (Proxmox VPS или хостинг)
- Поддержка Caddy с автоматическим получением и обновлением SSL сертификатов Let's Encrypt
- Автоматическая генерация секретных ключей
- Настройка PostgreSQL с ограничением доступа только localhost
- Отключение федерации Matrix для приватного использования
- Полная автоматизация без ручного управления сертификатами

## Требования

- Ubuntu 20 LTS / Ubuntu 22 LTS
- Root доступ
- Настроенные DNS записи для доменов (A-записи должны указывать на ваш сервер)

## Использование

1. Клонируйте репозиторий:
```bash
git clone https://github.com/yourusername/matrix-setup.git
cd matrix-setup
```

2. Запустите скрипт от root:
```bash
chmod +x setup-matrix.sh
sudo ./setup-matrix.sh
```

3. Следуйте инструкциям на экране

## Для Proxmox VPS

Если установка выполняется на Proxmox VPS, скрипт автоматически определит это и предоставит конфигурацию для добавления в основной Caddyfile хоста.

Добавьте предоставленные строки в `/etc/caddy/Caddyfile` на хосте Proxmox и перезапустите Caddy:
```bash
systemctl reload caddy
```

## SSL сертификаты

Caddy автоматически:
- Получает SSL сертификаты Let's Encrypt при первом запуске
- Обновляет сертификаты автоматически
- Не требует дополнительной настройки

**Важно**: После установки подождите несколько минут для получения сертификатов.

## После установки

1. Создайте первого пользователя:
```bash
register_new_matrix_user -c /etc/matrix-synapse/homeserver.yaml http://localhost:8008
```

2. Доступ к сервисам:
   - Matrix Synapse: https://matrix.yourdomain.com
   - Element Web: https://element.yourdomain.com  
   - Synapse Admin: https://admin.yourdomain.com

## Исправленные проблемы

- Убрано ручное управление сертификатами (Caddy делает это автоматически)
- Добавлена установка git (отсутствовала)
- Добавлена установка psycopg2 через pip3
- Исправлено определение версии PostgreSQL
- Добавлен безопасный ввод пароля
- Исправлена переменная окружения для Synapse Admin
- Добавлена проверка статуса сервисов
- Добавлено создание отдельной директории для synapse-admin
- Упрощена логика установки благодаря автоматическому управлению SSL

## Безопасность

- PostgreSQL ограничен localhost
- Отключена регистрация пользователей
- Отключена федерация Matrix
- Используются случайные секретные ключи
- Автоматические SSL сертификаты Let's Encrypt через Caddy

## Преимущества использования Caddy

- Автоматическое получение и обновление SSL сертификатов
- Простая конфигурация
- Высокая производительность
- Встроенная поддержка HTTP/2 и HTTP/3
- Автоматическое перенаправление с HTTP на HTTPS
