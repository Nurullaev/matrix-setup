# Matrix Setup Script

Автоматизированный скрипт для установки Matrix Synapse + Element Web + Synapse Admin + PostgreSQL + Coturn на Ubuntu 20/22/24 LTS.

## Особенности

- Автоматическое определение типа сервера (Proxmox VPS или хостинг)
- Поддержка Caddy с автоматическим получением и обновлением SSL сертификатов Let's Encrypt (только для хостинга)
- Автоматическая генерация секретных ключей
- Настройка PostgreSQL с ограничением доступа только localhost
- Отключение федерации Matrix для приватного использования
- Полная автоматизация без ручного управления сертификатами

## Требования

- Ubuntu 22 LTS / Ubuntu 24 LTS
- Root доступ
- Настроенные DNS записи для доменов (A-записи должны указывать на ваш сервер)

## ⚡ Быстрая установка

```bash
wget -qO setup-matrix.sh https://raw.githubusercontent.com/gopnikgame/matrix-setup/main/setup-matrix.sh && chmod +x setup-matrix.sh && sudo ./setup-matrix.sh
```

## Использование

1. Клонируйте репозиторий:
```bash
git clone https://github.com/gopnikgame/matrix-setup.git
cd matrix-setup
```

2. Запустите скрипт от root:
```bash
chmod +x setup-matrix.sh
sudo ./setup-matrix.sh
```

3. Следуйте инструкциям на экране

## Для Proxmox VPS

Если установка выполняется на Proxmox VPS, скрипт автоматически определит это и:
- НЕ будет устанавливать Caddy на VPS
- Предоставит готовую конфигурацию для добавления в основной Caddyfile хоста

Добавьте предоставленные строки в `/etc/caddy/Caddyfile` на хосте Proxmox и перезапустите Caddy:
```bash
systemctl reload caddy
```

## Для хостинга VPS

На хостинге VPS скрипт:
- Автоматически установит и настроит Caddy
- Настроит SSL сертификаты Let's Encrypt
- Создаст готовый к работе Caddyfile

## SSL сертификаты

Caddy автоматически:
- Получает SSL сертификаты Let's Encrypt при первом запуске
- Обновляет сертификаты автоматически
- Не требует дополнительной настройки

**Важно**: После установки подождите несколько минут для получения сертификатов.

## После установки

1. Создайте первого пользователя-администратора:
```bash
register_new_matrix_user -c /etc/matrix-synapse/homeserver.yaml http://localhost:8008
```
   **Важно**: Укажите пользователя как администратора при создании!

2. Доступ к сервисам:
   - **Matrix Synapse**: https://matrix.yourdomain.com
   - **Element Web**: https://element.yourdomain.com  
   - **Synapse Admin**: https://admin.yourdomain.com

3. **Первый вход в Synapse Admin**:
   - Откройте Synapse Admin по указанному адресу
   - Используйте учетные данные администратора из шага 1
   - Homeserver будет автоматически ограничен вашим доменом

## Synapse Admin

Веб-интерфейс для администрирования Matrix сервера включает:

- ✅ **Управление пользователями** - создание, блокировка, деактивация
- ✅ **Управление комнатами** - просмотр, модерация, удаление
- ✅ **Мониторинг сервера** - статистика, логи, производительность  
- ✅ **Настройка политик** - права доступа, лимиты
- ✅ **Ограниченный доступ** - только к вашему homeserver
- ✅ **Совместимость** - требует Synapse v1.93.0+ (автоматически устанавливается)

**Требования**: Доступ к эндпоинтам `/_matrix` и `/_synapse/admin` (настроены автоматически)

## Исправленные проблемы

### Версия 2.0
- **ИСПРАВЛЕНО**: Ошибка `externally-managed-environment` - заменено `pip3 install psycopg2` на системный пакет `python3-psycopg2`
- **ИСПРАВЛЕНО**: Неправильная установка Caddy на Proxmox VPS - теперь Caddy устанавливается только на хостинге
- **ДОБАВЛЕНО**: Правильная логика определения типа сервера и соответствующие действия
- **УЛУЧШЕНО**: Более четкие инструкции для Proxmox VPS в выводе скрипта

### Предыдущие исправления
- Убрано ручное управление сертификатами (Caddy делает это автоматически)
- Добавлена установка git (отсутствовала)
- Исправлено определение версии PostgreSQL
- Добавлен безопасный ввод пароля
- Исправлена переменная окружения для Synapse Admin
- Добавлена проверка статуса сервисов
- Добавлено создание отдельной директории для synapse-admin
- Упрощена логика установки благодаря автоматическому управлению SSL

## Безопасность

- PostgreSQL ограничен localhost
- Отключена регистрация пользователей
- Отключена федерация Matrix
- Используются случайные секретные ключи
- Автоматические SSL сертификаты Let's Encrypt через Caddy (только для хостинга)

## Преимущества использования Caddy

- Автоматическое получение и обновление SSL сертификатов
- Простая конфигурация
- Высокая производительность
- Встроенная поддержка HTTP/2 и HTTP/3
- Автоматическое перенаправление с HTTP на HTTPS

## Совместимость

- ✅ Ubuntu 20.04 LTS
- ✅ Ubuntu 22.04 LTS
- ✅ Ubuntu 24.04 LTS
- ✅ Proxmox VPS
- ✅ Обычный хостинг VPS
