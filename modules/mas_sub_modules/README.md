# Модули Matrix Authentication Service (MAS)

Этот каталог содержит специализированные модули для управления Matrix Authentication Service (MAS).

## Описание модулей

### 1. `mas_removing.sh`
**Назначение**: Полное удаление MAS из системы  
**Функции**:
- `uninstall_mas()` - полное удаление MAS включая конфигурацию, данные и интеграцию
- Создание резервных копий перед удалением
- Очистка системных служб и файлов
- Опциональное удаление базы данных

### 2. `mas_manage_captcha.sh`
**Назначение**: Управление CAPTCHA в MAS  
**Функции**:
- `set_mas_captcha_config()` - настройка CAPTCHA провайдера
- `manage_captcha_settings()` - интерактивное меню управления CAPTCHA
- Поддержка reCAPTCHA v2, Cloudflare Turnstile, hCaptcha
- Валидация и тестирование конфигурации

### 3. `mas_manage_ban_usernames.sh`
**Назначение**: Управление заблокированными именами пользователей  
**Функции**:
- `manage_banned_usernames()` - интерактивное управление блокировками
- Поддержка различных типов блокировок:
  - Точные имена (literals)
  - Подстроки (substrings)
  - Регулярные выражения (regexes)
  - Префиксы (prefixes)
  - Суффиксы (suffixes)
- Тестирование имен пользователей
- Экспорт/импорт конфигурации

### 4. `mas_manage_mas_registration.sh`
**Назначение**: Управление регистрацией пользователей  
**Функции**:
- `manage_mas_registration()` - управление настройками регистрации
- `manage_mas_registration_tokens()` - создание и управление токенами регистрации
- `get_mas_registration_status()` - получение статуса открытой регистрации
- `get_mas_token_registration_status()` - получение статуса регистрации по токенам
- Создание токенов с лимитами и сроками действия

### 5. `mas_diagnosis_and_recovery.sh`
**Назначение**: Диагностика и восстановление MAS  
**Функции**:
- `diagnose_mas()` - комплексная диагностика системы
- `check_mas_files()` - проверка критически важных файлов
- `repair_mas()` - восстановление поврежденных компонентов
- `fix_mas_config_issues()` - исправление проблем конфигурации
- Проверка API, логов, базы данных
- Автоматическое восстановление файлов share

### 6. `mas_manage_sso.sh`
**Назначение**: Управление внешними SSO провайдерами  
**Функции**:
- `manage_sso_providers()` - интерактивное управление SSO
- Добавление/удаление OAuth2/OIDC провайдеров
- Поддержка Google, Microsoft, GitHub, Discord, Keycloak
- Настройка claims mapping
- Валидация конфигурации провайдеров

## Общие функции

Все модули используют общую библиотеку `common/common_lib.sh` и включают:

### Системные функции
- `check_root()` - проверка прав root
- `load_server_type()` - определение типа сервера
- `check_yq_dependency()` - проверка и установка yq

### Функции конфигурации
- `backup_file()` - создание резервных копий
- `restore_file()` - восстановление из копий
- `validate_yaml_config()` - проверка YAML синтаксиса
- `sync_*_changes()` - применение изменений с перезапуском MAS

### Функции логирования
- `log()` - цветное логирование с уровнями
- `print_header()` - красивые заголовки
- `safe_echo()` - безопасный вывод с поддержкой цветов

## Использование

### Запуск отдельного модуля
```bash
sudo ./modules/mas_sub_modules/mas_manage_captcha.sh
```

### Интеграция в основной скрипт
```bash
# Подключение модуля
source "./modules/mas_sub_modules/mas_manage_captcha.sh"

# Вызов функции
manage_captcha_settings
```

## Конфигурация

### Основные пути
- Конфигурация MAS: `/etc/mas/config.yaml`
- Конфигурация установщика: `/opt/matrix-install/`
- Резервные копии: `./backups/`
- Логи: `./logs/`

### Поддерживаемые переменные среды
- `MAS_CONFIG_FILE` - путь к конфигурации MAS
- `CONFIG_DIR` - директория конфигураций установщика
- `DEBUG_MODE` - включение отладочных сообщений

## Зависимости

### Обязательные
- `bash` (версия 4.0+)
- `systemctl` - управление службами
- `yq` - обработка YAML (устанавливается автоматически)

### Опциональные
- `python3` - валидация YAML
- `curl` - тестирование API
- `jq` - обработка JSON для SSO
- `openssl` - генерация токенов

## Безопасность

### Права доступа
- Модули требуют права root
- Конфигурационные файлы: `600 (rw-------)`
- Владелец файлов MAS: `matrix-synapse:matrix-synapse`

### Резервное копирование
- Автоматическое создание копий перед изменениями
- Именование с временными метками
- Сохранение в директории `./backups/`

## Диагностика

### Проверка модулей
```bash
# Проверка синтаксиса
bash -n modules/mas_sub_modules/mas_manage_captcha.sh

# Тестовый запуск
sudo bash -x modules/mas_sub_modules/mas_diagnosis_and_recovery.sh
```

### Логи и отладка
```bash
# Включение отладочного режима
export DEBUG_MODE=true

# Просмотр логов MAS
journalctl -u matrix-auth-service -f

# Диагностика MAS
mas doctor --config /etc/mas/config.yaml
```

## Поддержка

При возникновении проблем:

1. Проверьте логи: `journalctl -u matrix-auth-service -n 20`
2. Запустите диагностику: `sudo ./modules/mas_sub_modules/mas_diagnosis_and_recovery.sh`
3. Проверьте резервные копии в `./backups/`
4. Используйте функции восстановления в модулях

## Версионность

- Версия модулей: 1.1.0
- Совместимость: MAS 0.8.0+
- Последнее обновление: 2024

---

**Примечание**: Все модули совместимы между собой и используют единую архитектуру с общими библиотеками и стандартизированными интерфейсами.